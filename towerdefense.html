<!DOCTYPE html><html lang="en"><meta http-equiv="content-type" content="text/html;charset=UTF-8"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=0.5,maximum-scale=1,user-scalable=yes"><title>HTML5 Tower Defense</title><style>body,html{margin:0;padding:0;font-size:12px;line-height:20px;font-family:Verdana,"Times New Roman",serif;background:#1a74ba}h1{padding:0;margin:0;line-height:48px;font-size:18px;font-weight:700;font-family:Verdana,"Times New Roman",serif;letter-spacing:.12em}#wrapper{margin:0 auto}#td-wrapper{padding:8px 24px 60px 24px;background:#e0f4fc}#td-board{display:none;font-size:16px}#td-board canvas#td-canvas{position:relative;background:#fff;border:solid 1px #cdf}#td-loading{font-size:18px;line-height:48px;padding:60px 0 120px 0;font-style:italic}#about{color:#fff;padding:8px 24px}#about a{color:#fff}</style><script>var _TD={a:[],retina:window.devicePixelRatio||1,init:function(t,e){delete this.init;var i,n={version:"0.1.17",is_debug:!!e,is_paused:!0,width:16,height:16,show_monster_life:!0,fps:0,exp_fps:24,exp_fps_half:12,exp_fps_quarter:6,exp_fps_eighth:4,stage_data:{},defaultSettings:function(){return{step_time:36,grid_size:32*_TD.retina,padding:10*_TD.retina,global_speed:.1}},init:function(t){this.obj_board=n.lang.$e(t),this.canvas=this.obj_board.getElementsByTagName("canvas")[0],this.canvas.getContext&&(this.ctx=this.canvas.getContext("2d"),this.monster_type_count=n.getDefaultMonsterAttributes(),this.iframe=0,this.last_iframe_time=(new Date).getTime(),this.fps=0,this.start())},start:function(){clearTimeout(this._st),n.log("Start!");var i=this;return this._exp_fps_0=this.exp_fps-.4,this._exp_fps_1=this.exp_fps+.4,this.mode="normal",this.eventManager.clear(),this.lang.mix(this,this.defaultSettings()),this.stage=new n.Stage("stage-main",n.getDefaultStageData("stage_main")),this.canvas.setAttribute("width",this.stage.width),this.canvas.setAttribute("height",this.stage.height),this.canvas.style.width=this.stage.width/_TD.retina+"px",this.canvas.style.height=this.stage.height/_TD.retina+"px",this.canvas.onmousemove=function(t){var e=i.getEventXY.call(i,t);i.hover(e[0],e[1])},this.canvas.onclick=function(t){var e=i.getEventXY.call(i,t);i.click(e[0],e[1])},this.is_paused=!1,this.stage.start(),this.step(),this},checkCheat:function(t){switch(t){case"money+":this.money+=1e6,this.log("cheat success!");break;case"life+":this.life=100,this.log("cheat success!");break;case"life-":this.life=1,this.log("cheat success!");break;case"difficulty+":this.difficulty*=2,this.log("cheat success! difficulty = "+this.difficulty);break;case"difficulty-":this.difficulty/=2,this.log("cheat success! difficulty = "+this.difficulty)}},step:function(){if(this.is_debug&&_TD&&_TD.cheat&&(this.checkCheat(_TD.cheat),_TD.cheat=""),!this.is_paused){if(this.iframe++,this.iframe%50==0){var t=(new Date).getTime(),e=this.step_time;this.fps=Math.round(5e5/(t-this.last_iframe_time))/10,this.last_iframe_time=t,this.fps<this._exp_fps_0&&1<e?e--:this.fps>this._exp_fps_1&&e++,this.step_time=e}this.iframe%2400==0&&n.gc(),this.stage.step(),this.stage.render();var i=this;this._st=setTimeout(function(){i.step()},this.step_time)}},getEventXY:function(t){var e=n.lang.$e("wrapper"),i=t.clientX-e.offsetLeft-this.canvas.offsetLeft+Math.max(document.documentElement.scrollLeft,document.body.scrollLeft),s=t.clientY-e.offsetTop-this.canvas.offsetTop+Math.max(document.documentElement.scrollTop,document.body.scrollTop);return[i*_TD.retina,s*_TD.retina]},hover:function(t,e){this.eventManager.hover(t,e)},click:function(t,e){this.eventManager.click(t,e)},mouseHand:function(t){this.canvas.style.cursor=t?"pointer":"default"},log:function(t){this.is_debug&&window.console&&console.log},gc:function(){window.CollectGarbage&&(CollectGarbage(),setTimeout(CollectGarbage,1))}};for(i=0;this.a[i];i++)this.a[i](n);delete this.a,n.init(t)}};_TD.a.push(function(t){t.lang={$e:function(t){return document.getElementById(t)},$c:function(t,e,i){var s=document.createElement(t);for(var n in e=e||{})e.hasOwnProperty(n)&&s.setAttribute(n,e[n]);return i&&i.appendChild(s),s},strLeft:function(t,e){var i=t.slice(0,e),s=i.replace(/[^\x00-\xff]/g,"**").length;if(s<=e)return i;switch(s-=i.length){case 0:return i;case e:return t.slice(0,e>>1);default:var n=e-s,h=t.slice(n,e),a=h.replace(/[\x00-\xff]/g,"").length;return a?t.slice(0,n)+this.arguments.callee(h,a):t.slice(0,n)}},strLen2:function(t){return t.replace(/[^\x00-\xff]/g,"**").length},each:function(t,e){if(Array.prototype.forEach)t.forEach(e);else for(var i=0,s=t.length;i<s;i++)e(t[i])},any:function(t,e){for(var i=0,s=t.length;i<s;i++)if(e(t[i]))return t[i];return null},shift:function(t,e){for(;t[0];)e(t.shift())},rndSort:function(t){return t.concat().sort(function(){return Math.random()-.5})},_rndRGB2:function(t){var e=t.toString(16);return 2==e.length?e:"0"+e},rndRGB:function(){var t=Math.floor(256*Math.random()),e=Math.floor(256*Math.random()),i=Math.floor(256*Math.random());return"#"+this._rndRGB2(t)+this._rndRGB2(e)+this._rndRGB2(i)},rgb2Arr:function(t){if(7!=t.length)return[0,0,0];var e=t.substr(1,2),i=t.substr(3,2),s=t.substr(3,2);return[parseInt(e,16),parseInt(i,16),parseInt(s,16)]},rndStr:function(t){t=t||16;var e,i,s="1234567890abcdefghijklmnopqrstuvwxyz",n=[],h=s.length;for(e=0;e<t;e++)i=Math.floor(Math.random()*h),n.push(s.substr(i,1));return n.join("")},nullFunc:function(){},arrayEqual:function(t,e){var i,s=t.length;if(s!=e.length)return!1;for(i=0;i<s;i++)if(t[i]!=e[i])return!1;return!0},mix:function(t,e,i){if(!e||!t)return t;for(var s in e)!e.hasOwnProperty(s)||!1===i&&s in t||(t[s]=e[s]);return t}}}),_TD.a.push(function(o){o.eventManager={ex:-1,ey:-1,_registers:{},ontypes:["enter","hover","out","click"],current_type:"hover",isOn:function(t){return-1!=this.ex&&-1!=this.ey&&this.ex>t.x&&this.ex<t.x2&&this.ey>t.y&&this.ey<t.y2},_mkElEvtName:function(t,e){return t.id+"::_evt_::"+e},on:function(t,e,i){this._registers[this._mkElEvtName(t,e)]=[t,e,i]},removeEventListener:function(t,e){var i=this._mkElEvtName(t,e);delete this._registers[i]},clear:function(){delete this._registers,this._registers={}},step:function(){if(this.current_type){var t,e,i,s,n,h,a,l=this,r=this.ontypes.length,c=[];for(t in this._registers)this._registers.hasOwnProperty(t)&&(i=(e=this._registers[t])[0],s=e[1],n=e[2],i.is_valid?i.is_visiable&&(a=this.isOn(i),"click"!=this.current_type?"hover"==s&&i.is_hover&&a?(n(),this.current_type="hover"):"enter"==s&&!i.is_hover&&a?(i.is_hover=!0,n(),this.current_type="enter"):"out"==s&&i.is_hover&&!a&&(i.is_hover=!1,n(),this.current_type="out"):a&&"click"==s&&n()):c.push(i));o.lang.each(c,function(t){for(h=0;h<r;h++)l.removeEventListener(t,l.ontypes[h])}),this.current_type=""}},hover:function(t,e){"click"!=this.current_type&&(this.current_type="hover",this.ex=t,this.ey=e)},click:function(t,e){this.current_type="click",this.ex=t,this.ey=e}}}),_TD.a.push(function(i){i.Stage=function(t,e){this.id=t||"stage-"+i.lang.rndStr(),this.cfg=e||{},this.width=this.cfg.width||640,this.height=this.cfg.height||540,this.mode="normal",this.state=0,this.acts=[],this.current_act=null,this._step2=i.lang.nullFunc,this._init()},i.Stage.prototype={_init:function(){"function"==typeof this.cfg.init&&this.cfg.init.call(this),"function"==typeof this.cfg.step2&&(this._step2=this.cfg.step2)},start:function(){this.state=1,i.lang.each(this.acts,function(t){t.start()})},pause:function(){this.state=2},gameover:function(){this.current_act.gameover()},clear:function(){this.state=3,i.lang.each(this.acts,function(t){t.clear()})},step:function(){1==this.state&&this.current_act&&(i.eventManager.step(),this.current_act.step(),this._step2())},render:function(){0!=this.state&&3!=this.state&&this.current_act&&this.current_act.render()},addAct:function(t){this.acts.push(t)},addElement:function(t,e,i){this.current_act&&this.current_act.addElement(t,e,i)}}}),_TD.a.push(function(i){i.Act=function(t,e){this.stage=t,this.id=e||"act-"+i.lang.rndStr(),this.state=0,this.scenes=[],this.end_queue=[],this.current_scene=null,this._init()},i.Act.prototype={_init:function(){this.stage.addAct(this)},start:function(){return this.stage.current_act&&3!=this.stage.current_act.state?(this.state=0,void this.stage.current_act.queue(this.start)):(this.state=1,this.stage.current_act=this,void i.lang.each(this.scenes,function(t){t.start()}))},pause:function(){this.state=2},end:function(){this.state=3;for(var t;t=this.end_queue.shift();)t();this.stage.current_act=null},queue:function(t){this.end_queue.push(t)},clear:function(){this.state=3,i.lang.each(this.scenes,function(t){t.clear()})},step:function(){1==this.state&&this.current_scene&&this.current_scene.step()},render:function(){0!=this.state&&3!=this.state&&this.current_scene&&this.current_scene.render()},addScene:function(t){this.scenes.push(t)},addElement:function(t,e,i){this.current_scene&&this.current_scene.addElement(t,e,i)},gameover:function(){this.current_scene.gameover()}}}),_TD.a.push(function(s){s.Scene=function(t,e){this.act=t,this.stage=t.stage,this.is_gameover=!1,this.id=e||"scene-"+s.lang.rndStr(),this.state=0,this.end_queue=[],this._step_elements=[[],[],[]],this._render_elements=[[],[],[],[],[],[],[],[],[],[]],this._init()},s.Scene.prototype={_init:function(){this.act.addScene(this),this.wave=0},start:function(){return this.act.current_scene&&this.act.current_scene!=this&&3!=this.act.current_scene.state?(this.state=0,void this.act.current_scene.queue(this.start)):(this.state=1,void(this.act.current_scene=this))},pause:function(){this.state=2},end:function(){this.state=3;for(var t;t=this.end_queue.shift();)t();this.clear(),this.act.current_scene=null},clear:function(){s.lang.shift(this._step_elements,function(t){s.lang.shift(t,function(t){t.del()})}),s.lang.shift(this._render_elements,function(t){s.lang.shift(t,function(t){t.del()})})},queue:function(t){this.end_queue.push(t)},gameover:function(){this.is_gameover||(this.pause(),this.is_gameover=!0)},step:function(){var t,e;if(1==this.state)for(s.life<=0&&(s.life=0,this.gameover()),t=0;t<3;t++){e=[];var i=this._step_elements[t];s.lang.shift(i,function(t){t.is_valid?(t.is_paused||t.step(),e.push(t)):setTimeout(function(){t=null},500)}),this._step_elements[t]=e}},render:function(){if(0!=this.state&&3!=this.state){var t,e;for(s.ctx.clearRect(0,0,this.stage.width,this.stage.height),t=0;t<10;t++){e=[];var i=this._render_elements[t];s.lang.shift(i,function(t){t.is_valid&&(t.is_visiable&&t.render(),e.push(t))}),this._render_elements[t]=e}this.is_gameover&&this.panel.gameover_obj.show()}},addElement:function(t,e,i){e=e||t.step_level||1,i=i||t.render_level,this._step_elements[e].push(t),this._render_elements[i].push(t),t.scene=this,t.step_level=e,t.render_level=i}}}),_TD.a.push(function(n){n.Element=function(t,e){this.id=t||"el-"+n.lang.rndStr(),this.cfg=e||{},this.is_valid=!0,this.is_visiable=void 0===e.is_visiable||e.is_visiable,this.is_paused=!1,this.is_hover=!1,this.x=this.cfg.x||-1,this.y=this.cfg.y||-1,this.width=this.cfg.width||0,this.height=this.cfg.height||0,this.step_level=e.step_level||1,this.render_level=e.render_level,this.on_events=e.on_events||[],this._init()},n.Element.prototype={_init:function(){var t,e,i=this;for(t=0,e=this.on_events.length;t<e;t++)switch(this.on_events[t]){case"enter":this.on("enter",function(){i.onEnter()});break;case"out":this.on("out",function(){i.onOut()});break;case"hover":this.on("hover",function(){i.onHover()});break;case"click":this.on("click",function(){i.onClick()})}this.calculatePos()},calculatePos:function(){this.cx=this.x+this.width/2,this.cy=this.y+this.height/2,this.x2=this.x+this.width,this.y2=this.y+this.height},start:function(){this.is_paused=!1},pause:function(){this.is_paused=!0},hide:function(){this.is_visiable=!1,this.onOut()},show:function(){this.is_visiable=!0},del:function(){this.is_valid=!1},on:function(t,e){n.eventManager.on(this,t,e)},onEnter:n.lang.nullFunc,onOut:n.lang.nullFunc,onHover:n.lang.nullFunc,onClick:n.lang.nullFunc,step:n.lang.nullFunc,render:n.lang.nullFunc,addToScene:function(e,i,s,t){this.scene=e,isNaN(i)||(this.step_level=i||this.step_level,this.render_level=s||this.render_level,t&&n.lang.each(t,function(t){e.addElement(t,i,s)}),e.addElement(this,i,s))}}}),_TD.a.push(function(l){function r(t,e){var i=new l.Element(t,e);return l.lang.mix(i,h),i._init(e),i}var s={_init:function(t){t=t||{},this.grid_x=t.grid_x||10,this.grid_y=t.grid_y||10,this.x=t.x||0,this.y=t.y||0,this.width=this.grid_x*l.grid_size,this.height=this.grid_y*l.grid_size,this.x2=this.x+this.width,this.y2=this.y+this.width,this.grids=[],this.entrance=this.exit=null,this.buildings=[],this.monsters=[],this.bullets=[],this.scene=t.scene,this.is_main_map=!!t.is_main_map,this.select_hl=l.MapSelectHighLight(this.id+"-hl",{map:this}),this.select_hl.addToScene(this.scene,1,9),this.selected_building=null,this._wait_clearInvalidElements=20,this._wait_add_monsters=0,this._wait_add_monsters_arr=[],this.is_main_map&&(this.mmm=new r(this.id+"-mmm",{map:this}),this.mmm.addToScene(this.scene,1,7));var e,i,s,n=this.grid_x*this.grid_y,h=t.grid_data||[];for(e=0;e<n;e++)(i=h[e]||{}).mx=e%this.grid_x,i.my=Math.floor(e/this.grid_x),i.map=this,i.step_level=this.step_level,i.render_level=this.render_level,s=new l.Grid(this.id+"-grid-"+i.mx+"-"+i.my,i),this.grids.push(s);t.entrance&&t.exit&&!l.lang.arrayEqual(t.entrance,t.exit)&&(this.entrance=this.getGrid(t.entrance[0],t.entrance[1]),this.entrance.is_entrance=!0,this.exit=this.getGrid(t.exit[0],t.exit[1]),this.exit.is_exit=!0);var a=this;t.grids_cfg&&l.lang.each(t.grids_cfg,function(t){var e=a.getGrid(t.pos[0],t.pos[1]);e&&(isNaN(t.passable_flag)||(e.passable_flag=t.passable_flag),isNaN(t.build_flag)||(e.build_flag=t.build_flag),t.building&&e.addBuilding(t.building))})},checkHasWeapon:function(){this.has_weapon=null!=this.anyBuilding(function(t){return t.is_weapon})},getGrid:function(t,e){var i=e*this.grid_x+t;return this.grids[i]},anyMonster:function(t){return l.lang.any(this.monsters,t)},anyBuilding:function(t){return l.lang.any(this.buildings,t)},anyBullet:function(t){return l.lang.any(this.bullets,t)},eachBuilding:function(t){l.lang.each(this.buildings,t)},eachMonster:function(t){l.lang.each(this.monsters,t)},eachBullet:function(t){l.lang.each(this.bullets,t)},preBuild:function(t){l.mode="build",this.pre_building&&this.pre_building.remove(),this.pre_building=new l.Building(this.id+"-pre-building-"+l.lang.rndStr(),{type:t,map:this,is_pre_building:!0}),this.scene.addElement(this.pre_building,1,this.render_level+1)},cancelPreBuild:function(){l.mode="normal",this.pre_building&&this.pre_building.remove()},clearInvalidElements:function(){if(0<this._wait_clearInvalidElements)this._wait_clearInvalidElements--;else{this._wait_clearInvalidElements=20;var e=[];l.lang.shift(this.buildings,function(t){t.is_valid&&e.push(t)}),this.buildings=e,e=[],l.lang.shift(this.monsters,function(t){t.is_valid&&e.push(t)}),this.monsters=e,e=[],l.lang.shift(this.bullets,function(t){t.is_valid&&e.push(t)}),this.bullets=e}},addMonster:function(t){this.entrance&&("number"==typeof t&&(t=new l.Monster(null,{idx:t,difficulty:l.difficulty,step_level:this.step_level,render_level:this.render_level+2})),this.entrance.addMonster(t))},addMonsters:function(t,e){this._wait_add_monsters=t,this._wait_add_monsters_objidx=e},addMonsters2:function(t){this._wait_add_monsters_arr=t},checkPassable:function(t,e){var i=this.getGrid(t,e);return null!=i&&1==i.passable_flag&&2!=i.build_flag},step:function(){if(this.clearInvalidElements(),0<this._wait_add_monsters)this.addMonster(this._wait_add_monsters_objidx),this._wait_add_monsters--;else if(0<this._wait_add_monsters_arr.length){var t=this._wait_add_monsters_arr.shift();this.addMonsters(t[0],t[1])}},render:function(){var t=l.ctx;t.strokeStyle="#99a",t.lineWidth=_TD.retina,t.beginPath(),t.strokeRect(this.x+.5,this.y+.5,this.width,this.height),t.closePath(),t.stroke()},onOut:function(){this.is_main_map&&this.pre_building&&this.pre_building.hide()}};l.Map=function(t,e){e.on_events=["enter","out"];var i=new l.Element(t,e);return l.lang.mix(i,s),i._init(e),i};var n={_init:function(t){this.map=t.map,this.width=l.grid_size+2,this.height=l.grid_size+2,this.is_visiable=!1},show:function(t){this.x=t.x,this.y=t.y,this.is_visiable=!0},render:function(){var t=l.ctx;t.lineWidth=2,t.strokeStyle="#f93",t.beginPath(),t.strokeRect(this.x,this.y,this.width-1,this.height-1),t.closePath(),t.stroke()}};l.MapSelectHighLight=function(t,e){var i=new l.Element(t,e);return l.lang.mix(i,n),i._init(e),i};var h={_init:function(t){this.map=t.map,this.x1=this.map.x,this.y1=this.map.y,this.x2=this.map.x2+1,this.y2=this.map.y2+1,this.w=this.map.scene.stage.width,this.h=this.map.scene.stage.height,this.w2=this.w-this.x2,this.h2=this.h-this.y2},render:function(){var t=l.ctx;t.fillStyle="#fff",t.beginPath(),t.fillRect(0,0,this.x1,this.h),t.fillRect(0,0,this.w,this.y1),t.fillRect(0,this.y2,this.w,this.h2),t.fillRect(this.x2,0,this.w2,this.h),t.closePath(),t.fill()}}}),_TD.a.push(function(s){var n={_init:function(t){t=t||{},this.map=t.map,this.scene=this.map.scene,this.mx=t.mx,this.my=t.my,this.width=s.grid_size,this.height=s.grid_size,this.is_entrance=this.is_exit=!1,this.passable_flag=1,this.build_flag=1,this.building=null,this.calculatePos()},calculatePos:function(){this.x=this.map.x+this.mx*s.grid_size,this.y=this.map.y+this.my*s.grid_size,this.x2=this.x+s.grid_size,this.y2=this.y+s.grid_size,this.cx=Math.floor(this.x+s.grid_size/2),this.cy=Math.floor(this.y+s.grid_size/2)},checkBlock:function(){if(this.is_entrance||this.is_exit)return this._block_msg=s._t("entrance_or_exit_be_blocked"),!0;var t,i=this;return(t=new s.FindWay(this.map.grid_x,this.map.grid_y,this.map.entrance.mx,this.map.entrance.my,this.map.exit.mx,this.map.exit.my,function(t,e){return!(t==i.mx&&e==i.my)&&i.map.checkPassable(t,e)}).is_blocked)?this._block_msg=s._t("blocked"):(t=!!this.map.anyMonster(function(t){return t.chkIfBlocked(i.mx,i.my)}))&&(this._block_msg=s._t("monster_be_blocked")),t},buyBuilding:function(t){var e=s.getDefaultBuildingAttributes(t).cost||0;s.money>=e?(s.money-=e,this.addBuilding(t)):(s.log(s._t("not_enough_money",[e])),this.scene.panel.balloontip.msg(s._t("not_enough_money",[e]),this))},addBuilding:function(t){this.building&&this.removeBuilding();var e=new s.Building("building-"+t+"-"+s.lang.rndStr(),{type:t,step_level:this.step_level,render_level:this.render_level});e.locate(this),this.scene.addElement(e,this.step_level,this.render_level+1),this.map.buildings.push(e),this.building=e,this.build_flag=2,this.map.checkHasWeapon(),this.map.pre_building&&this.map.pre_building.hide()},removeBuilding:function(){2==this.build_flag&&(this.build_flag=1),this.building&&this.building.remove(),this.building=null},addMonster:function(t){t.beAddToGrid(this),this.map.monsters.push(t),t.start()},hightLight:function(t){this.map.select_hl[t?"show":"hide"](this)},render:function(){var t=s.ctx,e=this.x+.5,i=this.y+.5;this.is_hover&&(t.fillStyle="rgba(255, 255, 200, 0.2)",t.beginPath(),t.fillRect(e,i,this.width,this.height),t.closePath(),t.fill()),0==this.passable_flag&&(t.fillStyle="#fcc",t.beginPath(),t.fillRect(e,i,this.width,this.height),t.closePath(),t.fill()),(this.is_entrance||this.is_exit)&&(t.lineWidth=1,t.fillStyle="#ccc",t.beginPath(),t.fillRect(e,i,this.width,this.height),t.closePath(),t.fill(),t.strokeStyle="#666",t.fillStyle=this.is_entrance?"#fff":"#666",t.beginPath(),t.arc(this.cx,this.cy,.325*s.grid_size,0,2*Math.PI,!0),t.closePath(),t.fill(),t.stroke()),t.strokeStyle="#eee",t.lineWidth=1,t.beginPath(),t.strokeRect(e,i,this.width,this.height),t.closePath(),t.stroke()},onEnter:function(){if(this.map.is_main_map&&"build"==s.mode)1==this.build_flag?(this.map.pre_building.show(),this.map.pre_building.locate(this)):this.map.pre_building.hide();else if(this.map.is_main_map){var t="";this.is_entrance?t=s._t("entrance"):this.is_exit?t=s._t("exit"):0==this.passable_flag?t=s._t("_cant_pass"):0==this.build_flag&&(t=s._t("_cant_build")),t&&this.scene.panel.balloontip.msg(t,this)}},onOut:function(){this.scene.panel.balloontip.el==this&&this.scene.panel.balloontip.hide()},onClick:function(){1==this.scene.state&&("build"==s.mode&&this.map.is_main_map&&!this.building?this.checkBlock()?this.scene.panel.balloontip.msg(this._block_msg,this):this.buyBuilding(this.map.pre_building.type):!this.building&&this.map.selected_building&&(this.map.selected_building.toggleSelected(),this.map.selected_building=null))}};s.Grid=function(t,e){e.on_events=["enter","out","click"];var i=new s.Element(t,e);return s.lang.mix(i,n),i._init(e),i}}),_TD.a.push(function(a){var s={_init:function(t){this.is_selected=!1,this.level=0,this.killed=0,this.target=null,t=t||{},this.map=t.map||null,this.grid=t.grid||null,this.bullet_type=t.bullet_type||1,this.type=t.type,this.speed=t.speed,this.bullet_speed=t.bullet_speed,this.is_pre_building=!!t.is_pre_building,this.blink=this.is_pre_building,this.wait_blink=this._default_wait_blink=20,this.is_weapon="wall"!=this.type;var e=a.getDefaultBuildingAttributes(this.type);a.lang.mix(this,e),this.range_px=this.range*a.grid_size,this.money=this.cost,this.calculatePos()},getUpgradeCost:function(){return Math.floor(.75*this.money)},getSellMoney:function(){return Math.floor(.5*this.money)||1},toggleSelected:function(){this.is_selected=!this.is_selected,this.grid.hightLight(this.is_selected);var e=this;this.is_selected?(this.map.eachBuilding(function(t){t.is_selected=t==e}),(this.map.is_main_map?this.scene.panel_map:this.scene.map).eachBuilding(function(t){t.is_selected=!1,t.grid.hightLight(!1)}),(this.map.selected_building=this).map.is_main_map?this.scene.map.cancelPreBuild():this.scene.map.preBuild(this.type)):(this.map.selected_building==this&&(this.map.selected_building=null),this.map.is_main_map||this.scene.map.cancelPreBuild()),this.map.is_main_map&&(this.map.selected_building?(this.scene.panel.btn_upgrade.show(),this.scene.panel.btn_sell.show(),this.updateBtnDesc()):(this.scene.panel.btn_upgrade.hide(),this.scene.panel.btn_sell.hide()))},updateBtnDesc:function(){this.scene.panel.btn_upgrade.desc=a._t("upgrade",[a._t("building_name_"+this.type),this.level+1,this.getUpgradeCost()]),this.scene.panel.btn_sell.desc=a._t("sell",[a._t("building_name_"+this.type),this.getSellMoney()])},locate:function(t){this.grid=t,this.map=t.map,this.cx=this.grid.cx,this.cy=this.grid.cy,this.x=this.grid.x,this.y=this.grid.y,this.x2=this.grid.x2,this.y2=this.grid.y2,this.width=this.grid.width,this.height=this.grid.height,this.px=this.x+.5,this.py=this.y+.5,this.wait_blink=this._default_wait_blink,this._fire_wait=Math.floor(Math.max(2/(this.speed*a.global_speed),1)),this._fire_wait2=this._fire_wait},remove:function(){this.grid&&this.grid.building&&this.grid.building==this&&(this.grid.building=null),this.hide(),this.del()},findTarget:function(){if(this.is_weapon&&!this.is_pre_building&&this.grid){var e=this.cx,i=this.cy,s=Math.pow(this.range_px,2);this.target&&this.target.is_valid&&Math.pow(this.target.cx-e,2)+Math.pow(this.target.cy-i,2)<=s||(this.target=a.lang.any(a.lang.rndSort(this.map.monsters),function(t){return Math.pow(t.cx-e,2)+Math.pow(t.cy-i,2)<=s}))}},getTargetPosition:function(){if(this.target)return[this.target.cx,this.target.cy];var t=this.map.is_main_map?this.map.entrance:this.grid;return[t.cx,t.cy]},fire:function(){if(this.target&&this.target.is_valid){if("laser_gun"==this.type)return void this.target.beHit(this,this.damage);var t=this.muzzle||[this.cx,this.cy],e=t[0],i=t[1];new a.Bullet(null,{building:this,damage:this.damage,target:this.target,speed:this.bullet_speed,x:e,y:i})}},tryToFire:function(){this.is_weapon&&this.target&&(this._fire_wait--,0<this._fire_wait||(this._fire_wait<0?this._fire_wait=this._fire_wait2:this.fire()))},_upgrade2:function(t){this._upgrade_records[t]||(this._upgrade_records[t]=this[t]);var e=this._upgrade_records[t],i="max_"+t,s=this["_upgrade_rule_"+t]||a.default_upgrade_rule;e&&!isNaN(e)&&(e=s(this.level,e),this[i]&&!isNaN(this[i])&&this[i]<e&&(e=this[i]),this._upgrade_records[t]=e,this[t]=Math.floor(e))},upgrade:function(){this._upgrade_records||(this._upgrade_records={});var t,e=["damage","range","speed","life","shield"],i=e.length;for(t=0;t<i;t++)this._upgrade2(e[t]);this.level++,this.range_px=this.range*a.grid_size},tryToUpgrade:function(t){var e=this.getUpgradeCost(),i="";i=e>a.money?a._t("not_enough_money",[e]):(a.money-=e,this.money+=e,this.upgrade(),a._t("upgrade_success",[a._t("building_name_"+this.type),this.level,this.getUpgradeCost()])),this.updateBtnDesc(),this.scene.panel.balloontip.msg(i,t)},tryToSell:function(){this.is_valid&&(a.money+=this.getSellMoney(),this.grid.removeBuilding(),this.is_valid=!1,this.map.selected_building=null,this.map.select_hl.hide(),this.map.checkHasWeapon(),this.scene.panel.btn_upgrade.hide(),this.scene.panel.btn_sell.hide(),this.scene.panel.balloontip.hide())},step:function(){this.blink&&(this.wait_blink--,this.wait_blink<-this._default_wait_blink&&(this.wait_blink=this._default_wait_blink)),this.findTarget(),this.tryToFire()},render:function(){if(this.is_visiable&&!(this.wait_blink<0)){var t=a.ctx;a.renderBuilding(this),this.map.is_main_map&&(this.is_selected||this.is_pre_building||this.map.show_all_ranges)&&this.is_weapon&&0<this.range&&this.grid&&(t.lineWidth=_TD.retina,t.fillStyle="rgba(187, 141, 32, 0.15)",t.strokeStyle="#bb8d20",t.beginPath(),t.arc(this.cx,this.cy,this.range_px,0,2*Math.PI,!0),t.closePath(),t.fill(),t.stroke()),"laser_gun"==this.type&&this.target&&this.target.is_valid&&(t.lineWidth=3*_TD.retina,t.strokeStyle="rgba(50, 50, 200, 0.5)",t.beginPath(),t.moveTo(this.cx,this.cy),t.lineTo(this.target.cx,this.target.cy),t.closePath(),t.stroke(),t.lineWidth=_TD.retina,t.strokeStyle="rgba(150, 150, 255, 0.5)",t.beginPath(),t.lineTo(this.cx,this.cy),t.closePath(),t.stroke())}},onEnter:function(){if(!this.is_pre_building){var t;t=this.map.is_main_map?a._t("building_info"+("wall"==this.type?"_wall":""),[a._t("building_name_"+this.type),this.level,this.damage,this.speed,this.range,this.killed]):a._t("building_intro_"+this.type,[a.getDefaultBuildingAttributes(this.type).cost]),this.scene.panel.balloontip.msg(t,this.grid)}},onOut:function(){this.scene.panel.balloontip.el==this.grid&&this.scene.panel.balloontip.hide()},onClick:function(){this.is_pre_building||1!=this.scene.state||this.toggleSelected()}};a.Building=function(t,e){e.on_events=["enter","out","click"];var i=new a.Element(t,e);return a.lang.mix(i,s),i._init(e),i};var n={_init:function(t){t=t||{},this.speed=t.speed,this.damage=t.damage,this.target=t.target,this.cx=t.x,this.cy=t.y,this.r=t.r||Math.max(Math.log(this.damage),2),this.r<1&&(this.r=1),6<this.r&&(this.r=6),this.building=t.building||null,this.map=t.map||this.building.map,this.type=t.type||1,this.color=t.color||"#000",this.map.bullets.push(this),this.addToScene(this.map.scene,1,6),1==this.type&&this.calculate()},calculate:function(){var t,e,i,s,n=this.target.cx,h=this.target.cy;t=n-this.cx,e=h-this.cy,i=Math.sqrt(Math.pow(t,2)+Math.pow(e,2)),s=20*this.speed*a.global_speed,this.vx=t*s/i,this.vy=e*s/i},checkOutOfMap:function(){return this.is_valid=!(this.cx<this.map.x||this.cx>this.map.x2||this.cy<this.map.y||this.cy>this.map.y2),!this.is_valid},checkHit:function(){var e=this.cx,i=this.cy,s=this.r*_TD.retina,t=this.map.anyMonster(function(t){return Math.pow(t.cx-e,2)+Math.pow(t.cy-i,2)<=2*Math.pow(t.r+s,2)});return!!t&&(t.beHit(this.building,this.damage),this.is_valid=!1,a.Explode(this.id+"-explode",{cx:this.cx,cy:this.cy,r:this.r,step_level:this.step_level,render_level:this.render_level,color:this.color,scene:this.map.scene,time:.2}),!0)},step:function(){this.checkOutOfMap()||this.checkHit()||(this.cx+=this.vx,this.cy+=this.vy)},render:function(){var t=a.ctx;t.fillStyle=this.color,t.beginPath(),t.arc(this.cx,this.cy,this.r,0,2*Math.PI,!0),t.closePath(),t.fill()}};a.Bullet=function(t,e){var i=new a.Element(t,e);return a.lang.mix(i,n),i._init(e),i}}),_TD.a.push(function(h){var s={_init:function(t){t=t||{},this.is_monster=!0,this.idx=t.idx||1,this.difficulty=t.difficulty||1;var e=h.getDefaultMonsterAttributes(this.idx);this.speed=Math.floor((e.speed+this.difficulty/2)*(.5*Math.random()+.75)),this.speed<1&&(this.speed=1),this.speed>t.max_speed&&(this.speed=t.max_speed),this.life=this.life0=Math.floor(e.life*(this.difficulty+1)*(Math.random()+.5)*.5),this.life<1&&(this.life=this.life0=1),this.shield=Math.floor(e.shield+this.difficulty/2),this.shield<0&&(this.shield=0),this.damage=Math.floor((e.damage||1)*(.5*Math.random()+.75)),this.damage<1&&(this.damage=1),this.money=e.money||Math.floor(Math.sqrt((this.speed+this.life)*(this.shield+1)*this.damage)),this.money<1&&(this.money=1),this.color=e.color||h.lang.rndRGB(),this.r=Math.floor(1.2*this.damage)*_TD.retina,this.r<4*_TD.retina&&(this.r=4*_TD.retina),this.r>h.grid_size/2-4*_TD.retina&&(this.r=h.grid_size/2-4*_TD.retina),this.render=e.render,this.grid=null,this.map=null,this.next_grid=null,this.way=[],this.toward=2,this._dx=0,this._dy=0,this.is_blocked=!1},calculatePos:function(){var t=this.r;this.x=this.cx-t,this.y=this.cy-t,this.x2=this.cx+t,this.y2=this.cy+t},beHit:function(t,e){if(this.is_valid){var i=Math.ceil(.1*e);(e-=this.shield)<=i&&(e=i),this.life-=e,h.score+=Math.floor(Math.sqrt(e)),this.life<=0&&this.beKilled(t);var s=this.scene.panel.balloontip;s.el==this&&(s.text=h._t("monster_info",[this.life,this.shield,this.speed,this.damage]))}},beKilled:function(t){this.is_valid&&(this.life=0,this.is_valid=!1,h.money+=this.money,t.killed++,h.Explode(this.id+"-explode",{cx:this.cx,cy:this.cy,color:this.color,r:this.r,step_level:this.step_level,render_level:this.render_level,scene:this.grid.scene}))},arrive:function(){this.grid=this.next_grid,this.next_grid=null,this.checkFinish()},findWay:function(){var i=this,t=new h.FindWay(this.map.grid_x,this.map.grid_y,this.grid.mx,this.grid.my,this.map.exit.mx,this.map.exit.my,function(t,e){return i.map.checkPassable(t,e)});this.way=t.way},checkFinish:function(){this.grid&&this.map&&this.grid==this.map.exit&&(h.life-=this.damage,h.wave_damage+=this.damage,h.life<=0?(h.life=0,h.stage.gameover()):(this.pause(),this.del()))},beAddToGrid:function(t){this.grid=t,this.map=t.map,this.cx=t.cx,this.cy=t.cy,this.grid.scene.addElement(this)},getToward:function(){this.grid&&this.next_grid&&(this.grid.my<this.next_grid.my?this.toward=0:this.grid.mx<this.next_grid.mx?this.toward=1:this.grid.my>this.next_grid.my?this.toward=2:this.grid.mx>this.next_grid.mx&&(this.toward=3))},getNextGrid:function(){(0==this.way.length||Math.random()<.1)&&this.findWay();var t=this.way.shift();t&&!this.map.checkPassable(t[0],t[1])&&(this.findWay(),t=this.way.shift()),t&&(this.next_grid=this.map.getGrid(t[0],t[1]))},chkIfBlocked:function(i,s){var n=this;return new h.FindWay(this.map.grid_x,this.map.grid_y,this.grid.mx,this.grid.my,this.map.exit.mx,this.map.exit.my,function(t,e){return!(t==i&&e==s)&&n.map.checkPassable(t,e)}).is_blocked},beBlocked:function(){this.is_blocked||(this.is_blocked=!0,h.log("monster be blocked!"))},step:function(){if(this.is_valid&&!this.is_paused&&this.grid){if(!this.next_grid&&(this.getNextGrid(),!this.next_grid))return void this.beBlocked();if(this.cx==this.next_grid.cx&&this.cy==this.next_grid.cy)this.arrive();else{var t=this.next_grid.cx-this.cx,e=this.next_grid.cy-this.cy,i=t<0?-1:1,s=e<0?-1:1,n=this.speed*h.global_speed;Math.abs(t)<n&&Math.abs(e)<n?(this.cx=this.next_grid.cx,this.cy=this.next_grid.cy,this._dx=n-Math.abs(t),this._dy=n-Math.abs(e)):(this.cx+=0==t?0:i*(n+this._dx),this.cy+=0==e?0:s*(n+this._dy),this._dx=0,this._dy=0)}this.calculatePos()}},onEnter:function(){var t,e=this.scene.panel.balloontip;e.el==this?(e.hide(),e.el=null):(t=h._t("monster_info",[this.life,this.shield,this.speed,this.damage]),e.msg(t,this))},onOut:function(){}};h.Monster=function(t,e){e.on_events=["enter","out"];var i=new h.Element(t,e);return h.lang.mix(i,s),i._init(e),i};var n={_init:function(t){t=t||{};var e=h.lang.rgb2Arr(t.color);this.cx=t.cx,this.cy=t.cy,this.r=t.r*_TD.retina,this.step_level=t.step_level,this.render_level=t.render_level,this.rgb_r=e[0],this.rgb_g=e[1],this.rgb_b=e[2],this.rgb_a=1,this.wait=this.wait0=h.exp_fps*(t.time||1),t.scene.addElement(this)},step:function(){this.is_valid&&(this.wait--,this.r++,this.is_valid=0<this.wait,this.rgb_a=this.wait/this.wait0)},render:function(){var t=h.ctx;t.fillStyle="rgba("+this.rgb_r+","+this.rgb_g+","+this.rgb_b+","+this.rgb_a+")",t.beginPath(),t.arc(this.cx,this.cy,this.r,0,2*Math.PI,!0),t.closePath(),t.fill()}};h.Explode=function(t,e){var i=new h.Element(t,e);return h.lang.mix(i,n),i._init(e),i}}),_TD.a.push(function(s){var n={_init:function(t){t=t||{},this.x=t.x,this.y=t.y,this.scene=t.scene,this.map=t.main_map;var e=new s.Map("panel-map",s.lang.mix({x:this.x+t.map.x,y:this.y+t.map.y,scene:this.scene,step_level:this.step_level,render_level:this.render_level},t.map,!1));this.addToScene(this.scene,1,7),e.addToScene(this.scene,1,7,e.grids),this.scene.panel_map=e,this.gameover_obj=new s.GameOver("panel-gameover",{panel:this,scene:this.scene,step_level:this.step_level,is_visiable:!1,x:0,y:0,width:this.scene.stage.width,height:this.scene.stage.height,render_level:9}),this.balloontip=new s.BalloonTip("panel-balloon-tip",{scene:this.scene,step_level:this.step_level,render_level:9}),this.balloontip.addToScene(this.scene,1,9),this.btn_pause=new s.Button("panel-btn-pause",{scene:this.scene,x:this.x,y:this.y+260*_TD.retina,text:s._t("button_pause_text"),step_level:this.step_level,render_level:this.render_level+1,onClick:function(){1==this.scene.state?(this.scene.pause(),this.text=s._t("button_continue_text"),this.scene.panel.btn_upgrade.hide(),this.scene.panel.btn_sell.hide(),this.scene.panel.btn_restart.show()):2==this.scene.state&&(this.scene.start(),this.text=s._t("button_pause_text"),this.scene.panel.btn_restart.hide(),this.scene.map.selected_building&&(this.scene.panel.btn_upgrade.show(),this.scene.panel.btn_sell.show()))}}),this.btn_restart=new s.Button("panel-btn-restart",{scene:this.scene,x:this.x,y:this.y+300*_TD.retina,is_visiable:!1,text:s._t("button_restart_text"),step_level:this.step_level,render_level:this.render_level+1,onClick:function(){setTimeout(function(){s.stage.clear(),s.is_paused=!0,s.start(),s.mouseHand(!1)},0)}}),this.btn_upgrade=new s.Button("panel-btn-upgrade",{scene:this.scene,x:this.x,y:this.y+300*_TD.retina,is_visiable:!1,text:s._t("button_upgrade_text"),step_level:this.step_level,render_level:this.render_level+1,onClick:function(){this.scene.map.selected_building.tryToUpgrade(this)}}),this.btn_sell=new s.Button("panel-btn-sell",{scene:this.scene,x:this.x,y:this.y+340*_TD.retina,is_visiable:!1,text:s._t("button_sell_text"),step_level:this.step_level,render_level:this.render_level+1,onClick:function(){this.scene.map.selected_building.tryToSell(this)}})},step:function(){s.life_recover&&(this._life_recover=this._life_recover2=s.life_recover,this._life_recover_wait=this._life_recover_wait2=3*s.exp_fps,s.life_recover=0),this._life_recover&&s.iframe%s.exp_fps_eighth==0&&(s.life++,this._life_recover--)},render:function(){var t=s.ctx;if(t.textAlign="left",t.textBaseline="top",t.fillStyle="#000",t.font="normal "+12*_TD.retina+"px 'Courier New'",t.beginPath(),t.fillText(s._t("panel_money_title")+s.money,this.x,this.y),t.fillText(s._t("panel_score_title")+s.score,this.x,this.y+20*_TD.retina),t.fillText(s._t("panel_life_title")+s.life,this.x,this.y+40*_TD.retina),t.fillText(s._t("panel_building_title")+this.map.buildings.length,this.x,this.y+60*_TD.retina),t.fillText(s._t("panel_monster_title")+this.map.monsters.length,this.x,this.y+80*_TD.retina),t.fillText(s._t("wave_info",[this.scene.wave]),this.x,this.y+210*_TD.retina),t.closePath(),this._life_recover_wait){var e=this._life_recover_wait/this._life_recover_wait2;t.fillStyle="rgba(255, 0, 0, "+e+")",t.font="bold "+12*_TD.retina+"px 'Verdana'",t.beginPath(),t.fillText("+"+this._life_recover2,this.x+60*_TD.retina,this.y+40*_TD.retina),t.closePath(),this._life_recover_wait--}t.textAlign="right",t.fillStyle="#666",t.font="normal "+12*_TD.retina+"px 'Courier New'",t.beginPath(),t.fillText("version: "+s.version+" | oldj.net",s.stage.width-s.padding,s.stage.height-2*s.padding),t.closePath(),t.textAlign="left",t.fillStyle="#666",t.font="normal "+12*_TD.retina+"px 'Courier New'",t.beginPath(),t.fillText("FPS: "+s.fps,s.padding,s.stage.height-2*s.padding),t.closePath()}};s.Panel=function(t,e){var i=new s.Element(t,e);return s.lang.mix(i,n),i._init(e),i};var h={_init:function(t){t=t||{},this.scene=t.scene},calculatePos:function(){var t=this.el;this.x=t.cx+.5,this.y=t.cy+.5,this.x+this.width>this.scene.stage.width-s.padding&&(this.x=this.x-this.width),this.px=this.x+5*_TD.retina,this.py=this.y+4*_TD.retina},msg:function(t,e){this.text=t;var i=s.ctx;i.font="normal "+12*_TD.retina+"px 'Courier New'",this.width=Math.max(i.measureText(t).width+10*_TD.retina,6*s.lang.strLen2(t)+10*_TD.retina),this.height=20*_TD.retina,e&&e.cx&&e.cy&&(this.el=e,this.calculatePos(),this.show())},step:function(){return this.el&&this.el.is_valid?void(this.el.is_monster&&this.calculatePos()):void this.hide()},render:function(){if(this.el){var t=s.ctx;t.lineWidth=_TD.retina,t.fillStyle="rgba(255, 255, 0, 0.5)",t.strokeStyle="rgba(222, 222, 0, 0.9)",t.beginPath(),t.rect(this.x,this.y,this.width,this.height),t.closePath(),t.fill(),t.stroke(),t.textAlign="left",t.textBaseline="top",t.fillStyle="#000",t.font="normal "+12*_TD.retina+"px 'Courier New'",t.beginPath(),t.fillText(this.text,this.px,this.py),t.closePath()}}};s.BalloonTip=function(t,e){var i=new s.Element(t,e);return s.lang.mix(i,h),i._init(e),i};var a={_init:function(t){t=t||{},this.text=t.text,this.onClick=t.onClick||s.lang.nullFunc,this.x=t.x,this.y=t.y,this.width=t.width||80*_TD.retina,this.height=t.height||30*_TD.retina,this.font_x=this.x+8*_TD.retina,this.font_y=this.y+9*_TD.retina,this.scene=t.scene,this.desc=t.desc||"",this.addToScene(this.scene,this.step_level,this.render_level),this.calculatePos()},onEnter:function(){s.mouseHand(!0),this.desc&&this.scene.panel.balloontip.msg(this.desc,this)},onOut:function(){s.mouseHand(!1),this.scene.panel.balloontip.el==this&&this.scene.panel.balloontip.hide()},render:function(){var t=s.ctx;t.lineWidth=2*_TD.retina,t.fillStyle=this.is_hover?"#eee":"#ccc",t.strokeStyle="#999",t.beginPath(),t.rect(this.x,this.y,this.width,this.height),t.closePath(),t.fill(),t.stroke(),t.textAlign="left",t.textBaseline="top",t.fillStyle="#000",t.font="normal "+12*_TD.retina+"px 'Courier New'",t.beginPath(),t.fillText(this.text,this.font_x,this.font_y),t.closePath(),t.fill()}};s.Button=function(t,e){e.on_events=["enter","out","click"];var i=new s.Element(t,e);return s.lang.mix(i,a),i._init(e),i};var l={_init:function(t){this.panel=t.panel,this.scene=t.scene,this.addToScene(this.scene,1,9)},render:function(){this.panel.btn_pause.hide(),this.panel.btn_upgrade.hide(),this.panel.btn_sell.hide(),this.panel.btn_restart.show();var t=s.ctx;t.textAlign="center",t.textBaseline="middle",t.fillStyle="#ccc",t.font="bold 62px 'Verdana'",t.beginPath(),t.fillText("GAME OVER",this.width/2,this.height/2),t.closePath(),t.fillStyle="#f00",t.font="bold 60px 'Verdana'",t.beginPath(),t.fillText("GAME OVER",this.width/2,this.height/2),t.closePath()}};s.GameOver=function(t,e){var i=new s.Element(t,e);return s.lang.mix(i,l),i._init(e),i},s.recover=function(t){s.life_recover=t,s.log("life recover: "+t)}}),_TD.a.push(function(h){var e=function(){var t=new h.Act(this,"act-1"),e=new h.Scene(t,"scene-1"),i=h.getDefaultStageData("scene_endless");this.config=i.config,h.life=this.config.life,h.money=this.config.money,h.score=this.config.score,h.difficulty=this.config.difficulty,h.wave_damage=this.config.wave_damage;var s=new h.Map("main-map",h.lang.mix({scene:e,is_main_map:!0,step_level:1,render_level:2},i.map));s.addToScene(e,1,2,s.grids),e.map=s,e.panel=new h.Panel("panel",h.lang.mix({scene:e,main_map:s,step_level:1,render_level:7},i.panel)),this.newWave=i.newWave,this.map=s,this.wait_new_wave=this.config.wait_new_wave},i=function(){var t=this.current_act.current_scene,e=t.wave;if((0!=e||this.map.has_weapon)&&1==t.state&&0==this.map.monsters.length){if(0<e&&this.wait_new_wave==this.config.wait_new_wave-1){var i=0;e%10==0?i=10:e%5==0&&(i=5),100<h.life+i&&(i=100-h.life),0<i&&h.recover(i)}if(0<this.wait_new_wave)return void this.wait_new_wave--;this.wait_new_wave=this.config.wait_new_wave,e++,t.wave=e,this.newWave({map:this.map,wave:e})}};h.getDefaultStageData=function(t){return{stage_main:{width:640*_TD.retina,height:560*_TD.retina,init:e,step2:i},scene_endless:{map:{grid_x:16,grid_y:16,x:h.padding,y:h.padding,entrance:[0,0],exit:[15,15],grids_cfg:[{pos:[3,3],passable_flag:0},{pos:[7,15],build_flag:0}]},panel:{x:2*h.padding+16*h.grid_size,y:h.padding,map:{grid_x:3,grid_y:3,x:0,y:110*_TD.retina,grids_cfg:[{pos:[0,0],building:"cannon"},{pos:[1,0],building:"LMG"},{pos:[2,0],building:"HMG"},{pos:[0,1],building:"laser_gun"},{pos:[0,2],building:"OP"},{pos:[2,2],building:"wall"}]}},config:{endless:!0,wait_new_wave:3*h.exp_fps,difficulty:1,wave:0,max_wave:-1,wave_damage:0,max_monsters_per_wave:100,money:50000,score:0,life:1e3,waves:[[],[[1,0]],[[1,0],[1,1]],[[2,0],[1,1]],[[2,0],[1,1]],[[3,0],[2,1]],[[4,0],[2,1]],[[5,0],[3,1],[1,2]],[[6,0],[4,1],[1,2]],[[7,0],[3,1],[2,2]],[[8,0],[4,1],[3,2]]]},newWave:function(t){var e=(t=t||{}).map,i=t.wave||1,s=h.wave_damage||0;1==i||(0==s?i<5?h.difficulty*=1.05:30<h.difficulty?h.difficulty*=1.1:h.difficulty*=1.2:50<=h.wave_damage?h.difficulty*=.6:30<=h.wave_damage?h.difficulty*=.7:20<=h.wave_damage?h.difficulty*=.8:10<=h.wave_damage?h.difficulty*=.9:10<=i&&(h.difficulty*=1.05)),h.difficulty<1&&(h.difficulty=1),h.log("wave "+i+", last wave damage = "+s+", difficulty = "+h.difficulty);var n=this.config.waves[i]||h.makeMonsters(Math.min(Math.floor(Math.pow(i,1.1)),this.config.max_monsters_per_wave));e.addMonsters2(n),h.wave_damage=0}}}[t]||{}}}),_TD.a.push(function(t){t.default_upgrade_rule=function(t,e){return 1.2*e},t.getDefaultBuildingAttributes=function(t){return{wall:{damage:0,range:0,speed:0,bullet_speed:0,life:100,shield:500,cost:5},cannon:{damage:12,range:4,max_range:8,speed:2,bullet_speed:6,life:100,shield:100,cost:300,_upgrade_rule_damage:function(t,e){return e*(t<=10?1.2:1.3)}},LMG:{damage:5,range:5,max_range:10,speed:3,bullet_speed:6,life:100,shield:50,cost:100},OP:{damage:1e3,range:1e3,max_range:1e5,speed:1e3,bullet_speed:10,life:100,shield:50,cost:100},HMG:{damage:30,range:3,max_range:5,speed:3,bullet_speed:5,life:100,shield:200,cost:800,_upgrade_rule_damage:function(t,e){return 1.3*e}},laser_gun:{damage:25,range:6,max_range:10,speed:20,life:100,shield:100,cost:2e3}}[t]||{}}}),_TD.a.push(function(c){function n(){if(this.is_valid&&this.grid){var t=c.ctx;if(t.strokeStyle="#000",t.lineWidth=1,t.fillStyle=this.color,t.beginPath(),t.arc(this.cx,this.cy,this.r,0,2*Math.PI,!0),t.closePath(),t.fill(),t.stroke(),c.show_monster_life){var e=Math.floor(c.grid_size/4),i=2*e-2*_TD.retina;t.fillStyle="#000",t.beginPath(),t.fillRect(this.cx-e,this.cy-this.r-6,2*e,4*_TD.retina),t.closePath(),t.fillStyle="#f00",t.beginPath(),t.fillRect(this.cx-e+_TD.retina,this.cy-this.r-(6-_TD.retina),this.life*i/this.life0,2*_TD.retina),t.closePath()}}}c.getDefaultMonsterAttributes=function(t){var e=[{name:"monster 1",desc:"最弱小的怪物",speed:3,max_speed:10,life:50,damage:1,shield:0,money:5},{name:"monster 2",desc:"稍强一些的小怪",speed:6,max_speed:20,life:50,damage:2,shield:1},{name:"monster speed",desc:"速度较快的小怪",speed:12,max_speed:30,life:50,damage:3,shield:1},{name:"monster life",desc:"生命值很强的小怪",speed:5,max_speed:10,life:500,damage:3,shield:1},{name:"monster shield",desc:"防御很强的小怪",speed:5,max_speed:10,life:50,damage:3,shield:20},{name:"monster damage",desc:"伤害值很大的小怪",speed:7,max_speed:14,life:50,damage:10,shield:2},{name:"monster speed-life",desc:"速度、生命都较高的怪物",speed:15,max_speed:30,life:100,damage:3,shield:3},{name:"monster speed-2",desc:"速度很快的怪物",speed:30,max_speed:40,life:30,damage:4,shield:1},{name:"monster shield-life",desc:"防御很强、生命值很高的怪物",speed:3,max_speed:10,life:300,damage:5,shield:15}];if(void 0===t)return e.length;var i=e[t]||e[0],s={};return c.lang.mix(s,i),s.render||(s.render=n),s},c.makeMonsters=function(t,e){var i,s,n,h,a=[],l=0,r=c.monster_type_count;if(!e)for(e=[],i=0;i<r;i++)e.push(i);for(;l<t;)n=t-l,s=Math.min(Math.floor(Math.random()*n)+1,3),h=Math.floor(Math.random()*r),a.push([s,e[h]]),l+=s;return a}}),_TD.a.push(function(h){function a(t,e,i,s,n,h){var a,l,r,c,o,_,d,u,g;if(e==s)a=e,l=i<n?i+h:i-h;else if(i==n)l=i,a=e<s?e+h:e-h;else{if(d=(r=(i-n)/(e-s))*r+1,u=2*(r*((c=i-e*r)-i)-e),g=Math.pow(c-i,2)+e*e-Math.pow(h,2),(o=Math.pow(u,2)-4*d*g)<0)return[0,0];_=(-u+(o=Math.sqrt(o)))/(2*d),l=r*(a=0<s-e&&0<_-e||s-e<0&&_-e<0?_:(-u-o)/(2*d))+c}return t.lineCap="round",t.moveTo(e,i),t.lineTo(a,l),[a,l]}var l={cannon:function(t,e,i,s,n){var h=t.getTargetPosition();e.fillStyle="#393",e.strokeStyle="#000",e.beginPath(),e.lineWidth=_TD.retina,e.arc(t.cx,t.cy,n-5,0,2*Math.PI,!0),e.closePath(),e.fill(),e.stroke(),e.lineWidth=3*_TD.retina,e.beginPath(),e.moveTo(t.cx,t.cy),t.muzzle=a(e,t.cx,t.cy,h[0],h[1],n),e.closePath(),e.stroke(),e.lineWidth=_TD.retina,e.fillStyle="#060",e.beginPath(),e.arc(t.cx,t.cy,7*_TD.retina,0,2*Math.PI,!0),e.closePath(),e.fill(),e.stroke(),e.fillStyle="#cec",e.beginPath(),e.arc(t.cx+2,t.cy-2,3*_TD.retina,0,2*Math.PI,!0),e.closePath(),e.fill()},LMG:function(t,e,i,s,n){var h=t.getTargetPosition();e.fillStyle="#36f",e.strokeStyle="#000",e.beginPath(),e.lineWidth=_TD.retina,e.arc(t.cx,t.cy,7*_TD.retina,0,2*Math.PI,!0),e.closePath(),e.fill(),e.stroke(),e.lineWidth=2*_TD.retina,e.beginPath(),e.moveTo(t.cx,t.cy),t.muzzle=a(e,t.cx,t.cy,h[0],h[1],n),e.closePath(),e.fill(),e.stroke(),e.lineWidth=_TD.retina,e.fillStyle="#66c",e.beginPath(),e.arc(t.cx,t.cy,5*_TD.retina,0,2*Math.PI,!0),e.closePath(),e.fill(),e.stroke(),e.fillStyle="#ccf",e.beginPath(),e.arc(t.cx+1,t.cy-1,2*_TD.retina,0,2*Math.PI,!0),e.closePath(),e.fill()},HMG:function(t,e,i,s,n){var h=t.getTargetPosition();e.fillStyle="#933",e.strokeStyle="#000",e.beginPath(),e.lineWidth=_TD.retina,e.arc(t.cx,t.cy,n-2,0,2*Math.PI,!0),e.closePath(),e.fill(),e.stroke(),e.lineWidth=5*_TD.retina,e.beginPath(),e.moveTo(t.cx,t.cy),t.muzzle=a(e,t.cx,t.cy,h[0],h[1],n),e.closePath(),e.fill(),e.stroke(),e.lineWidth=_TD.retina,e.fillStyle="#630",e.beginPath(),e.arc(t.cx,t.cy,n-5*_TD.retina,0,2*Math.PI,!0),e.closePath(),e.fill(),e.stroke(),e.fillStyle="#960",e.beginPath(),e.arc(t.cx+1,t.cy-1,8*_TD.retina,0,2*Math.PI,!0),e.closePath(),e.fill(),e.fillStyle="#fcc",e.beginPath(),e.arc(t.cx+3,t.cy-3,4*_TD.retina,0,2*Math.PI,!0),e.closePath(),e.fill()},OP:function(t,e,i,s,n){var h=t.getTargetPosition();e.fillStyle="#933",e.strokeStyle="#000",e.beginPath(),e.lineWidth=_TD.retina,e.arc(t.cx,t.cy,n-2,0,2*Math.PI,!0),e.closePath(),e.fill(),e.stroke(),e.lineWidth=5*_TD.retina,e.beginPath(),e.moveTo(t.cx,t.cy),t.muzzle=a(e,t.cx,t.cy,h[0],h[1],n),e.closePath(),e.fill(),e.stroke(),e.lineWidth=_TD.retina,e.fillStyle="#630",e.beginPath(),e.arc(t.cx,t.cy,n-5*_TD.retina,0,2*Math.PI,!0),e.closePath(),e.fill(),e.stroke(),e.fillStyle="#960",e.beginPath(),e.arc(t.cx+1,t.cy-1,8*_TD.retina,0,2*Math.PI,!0),e.closePath(),e.fill(),e.fillStyle="#fcc",e.beginPath(),e.arc(t.cx+3,t.cy-3,4*_TD.retina,0,2*Math.PI,!0),e.closePath(),e.fill()},wall:function(t,e,i,s,n){e.lineWidth=_TD.retina,e.fillStyle="#666",e.strokeStyle="#000",e.fillRect(t.cx-n+1,t.cy-n+1,s-1,s-1),e.beginPath(),e.moveTo(t.cx-n+.5,t.cy-n+.5),e.lineTo(t.cx-n+.5,t.cy+n+.5),e.lineTo(t.cx+n+.5,t.cy+n+.5),e.lineTo(t.cx+n+.5,t.cy-n+.5),e.lineTo(t.cx-n+.5,t.cy-n+.5),e.moveTo(t.cx-n+.5,t.cy+n+.5),e.lineTo(t.cx+n+.5,t.cy-n+.5),e.moveTo(t.cx-n+.5,t.cy-n+.5),e.lineTo(t.cx+n+.5,t.cy+n+.5),e.closePath(),e.stroke()},laser_gun:function(t,e){e.fillStyle="#f00",e.strokeStyle="#000",e.beginPath(),e.lineWidth=_TD.retina,e.moveTo(t.cx,t.cy-10*_TD.retina),e.lineTo(t.cx-8.66*_TD.retina,t.cy+5*_TD.retina),e.lineTo(t.cx+8.66*_TD.retina,t.cy+5*_TD.retina),e.lineTo(t.cx,t.cy-10*_TD.retina),e.closePath(),e.fill(),e.stroke(),e.fillStyle="#60f",e.beginPath(),e.arc(t.cx,t.cy,7*_TD.retina,0,2*Math.PI,!0),e.closePath(),e.fill(),e.stroke(),e.fillStyle="#000",e.beginPath(),e.arc(t.cx,t.cy,3*_TD.retina,0,2*Math.PI,!0),e.closePath(),e.fill(),e.fillStyle="#666",e.beginPath(),e.arc(t.cx+1,t.cy-1,_TD.retina,0,2*Math.PI,!0),e.closePath(),e.fill(),e.lineWidth=3*_TD.retina,e.beginPath(),e.moveTo(t.cx,t.cy),e.closePath(),e.fill(),e.stroke()}};h.renderBuilding=function(t){var e=h.ctx,i=t.map,s=h.grid_size,n=h.grid_size/2;(l[t.type]||l.wall)(t,e,i,s,n)}}),_TD.a.push(function(t){t._msg_texts={_cant_build:"Can't build here!",_cant_pass:"Can't pass!",entrance:"Entrance",exit:"Exit",not_enough_money:"Not enough money, need $${0}.",wave_info:"Wave ${0}",panel_money_title:"Money: ",panel_score_title:"Score: ",panel_life_title:"Life: ",panel_building_title:"Buildings: ",panel_monster_title:"Monsters: ",building_name_block:"Roadblock",building_name_cannon:"Cannon",building_name_LMG:"LMG",building_name_HMG:"HMG",building_name_laser_gun:"Laser gun",building_info:"${0}: Level ${1}, Damage ${2}, Speed ${3}, Range ${4}, Kill ${5}",building_info_wall:"${0}",building_intro_wall:"Roadblock: monsters could not pass ($${0})",building_intro_cannon:"Cannon: blance in range and damage ($${0})",building_intro_LMG:"Light Machine Gun: longer range, normal damage ($${0})",building_intro_HMG:"Heavy Machine Gun: fast shoot, greater damage, normal range ($${0})",building_intro_laser_gun:"Laser gun: greater damage, 100% hit ($${0})",click_to_build:"Left click to build ${0} ($${1})",upgrade:"Upgrade ${0} to level ${1} , cost $${2}。",sell:"Sell ${0} for $${1}",upgrade_success:"Upgrade success! ${0} upgrades to level ${1}. Next upgrade will take $${2}.",monster_info:"Monster: Life ${0}, Shield ${1}, Speed ${2}, Damage ${3}",button_upgrade_text:"Upgrade",button_sell_text:"Sell",button_start_text:"Start",button_restart_text:"Restart",button_pause_text:"Pause",button_continue_text:"Continue",button_pause_desc_0:"Pause the game",button_pause_desc_1:"Resume the game",blocked:"Can't build here, it will block the way from entrance to exit!",monster_be_blocked:"Can't build here, some monster will be blocked!",entrance_or_exit_be_blocked:"Can't build on the entrance or the exit!",_:"ERROR"},t._t=t.translate=function(t,e){e="object"==typeof e&&e.constructor==Array?e:[];var i,s=this._msg_texts[t]||this._msg_texts._,n=e.length;for(i=0;i<n;i++)s=s.replace("${"+i+"}",e[i]);return s}}),_TD.a.push(function(t){t.FindWay=function(t,e,i,s,n,h,a){this.m=[],this.w=t,this.h=e,this.x1=i,this.y1=s,this.x2=n,this.y2=h,this.way=[],this.len=this.w*this.h,this.is_blocked=this.is_arrived=!1,this.fPassable="function"==typeof a?a:function(){return!0},this._init()},t.FindWay.prototype={_init:function(){if(this.x1==this.x2&&this.y1==this.y2)return this.is_arrived=!0,void(this.way=[[this.x1,this.y1]]);for(var t=0;t<this.len;t++)this.m[t]=-2;for(this.x=this.x1,this.y=this.y1,this.distance=0,this.current=[[this.x,this.y]],this.setVal(this.x,this.y,0);this.next(););},getVal:function(t,e){var i=e*this.w+t;return i<this.len?this.m[i]:-1},setVal:function(t,e,i){var s=e*this.w+t;return!(s>this.len)&&void(this.m[s]=i)},getNeighborsOf:function(t,e){var i=[];return 0<e&&i.push([t,e-1]),t<this.w-1&&i.push([t+1,e]),e<this.h-1&&i.push([t,e+1]),0<t&&i.push([t-1,e]),i},getAllNeighbors:function(){var t,e,i,s=[],n=this.current.length;for(e=0;e<n;e++)i=this.current[e],t=this.getNeighborsOf(i[0],i[1]),s=s.concat(t);return s},findWay:function(){for(var t,e,i,s,n,h,a,l=this.x2,r=this.y2,c=this.len,o=-1;(l!=this.x1||r!=this.y1)&&0!=o&&this.way.length<c;){for(this.way.unshift([l,r]),e=(i=this.getNeighborsOf(l,r)).length,a=[],o=-1,s=0;s<e;s++)(h=this.getVal(i[s][0],i[s][1]))<0||(o<0||h<o)&&(o=h);for(s=0;s<e;s++)t=i[s],o==this.getVal(t[0],t[1])&&a.push(t);l=(t=a[s=1<(n=a.length)?Math.floor(Math.random()*n):0])[0],r=t[1]}},arrive:function(){this.current=[],this.is_arrived=!0,this.findWay()},blocked:function(){this.current=[],this.is_blocked=!0},next:function(){var t,e,i,s,n,h=this.getAllNeighbors(),a=h.length,l=[];for(this.distance++,s=0;s<a;s++)if(e=(t=h[s])[0],i=t[1],-2==this.getVal(e,i)&&(this.fPassable(e,i)?(n=this.distance,l.push(t)):n=-1,this.setVal(e,i,n),e==this.x2&&i==this.y2))return this.arrive(),!1;return 0==l.length?(this.blocked(),!1):(this.current=l,!0)}}})</script></head><body id="tower-defense"><div id="wrapper"><div id="td-wrapper"><h1>HTML5 Tower Defense</h1><div id="td-loading">Loading...</div><div id="td-board"><canvas id="td-canvas">Sorry, it seems that you browser does not support HTML 5 Canvas tag. Please open this page in IE9, Chrome or Opera.</canvas></div><br><br></div><script type="text/javascript">window.onload=function(){_TD.init("td-board",!0),document.getElementById("td-loading").style.display="none",document.getElementById("td-board").style.display="block"}</script></body></html>